{{> layout/header }}

<div class="container mt-5">
    <h2 class="text-center">회원가입</h2>
    <form action="/user/sign-up" method="post" id="signUpForm">
        <input type="hidden" name="userType" value="{{userType}}"> <!-- 프리랜서 또는 기업 구분 -->
        <input type="hidden" name="socialType" id="socialType" value="local"> <!-- 기본 소셜 타입 설정 -->

        <div class="form-group">
            <label for="email">이메일</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="Enter email" required>
            <button type="button" id="checkDuplicateEmail" class="btn btn-secondary mt-2">중복 확인</button>
            <div id="emailCheckResult" class="mt-2"></div>
            비즈니스용 이메일 사용을 권장합니다.
        </div>
<!-- 휴대폰 번호 입력 및 인증 -->
<div class="form-group">
    <label for="phoneNumber">휴대폰 번호</label>
    <input type="text" class="form-control" id="inputPhoneNumber" name="phoneNumber" placeholder="Enter phone number" required>
    <button type="button" id="sendPhoneNumber" class="btn btn-secondary mt-2">인증번호 발송</button>
</div>

<!-- 인증번호 입력 -->
<div class="form-group">
    <label for="inputCertifiedNumber">인증번호</label>
    <input type="text" class="form-control" id="inputCertifiedNumber" name="certifiedNumber" placeholder="Enter certification number" required>
    <button type="button" id="checkBtn" class="btn btn-secondary mt-2">인증번호 확인</button>
</div>

        <div class="form-group">
            <label for="username">아이디</label>
            <input type="text" class="form-control" id="username" name="username" placeholder="Enter username" required>
        </div>
        <div class="form-group">
            <label for="password">비밀번호</label>
            <input type="password" class="form-control" id="password" name="password" placeholder="Enter password" required>
            8자 이상 32자 이하로 입력해 주세요.
        </div>

        <div class="form-group">
            <label for="passwordCheck">비밀번호 확인</label>
            <input type="password" class="form-control" id="passwordCheck" name="passwordCheck" 
            oninput="pwdCheck()" minlength="8" maxlength="32" placeholder="Confirm password" required>
        </div>
        <span id="pwdConfirm"></span>

        <button type="submit" id="signUpBtn" class="btn btn-primary btn-block">회원가입</button>
    </form>

    <hr>
    <div class="text-center">
        <p>또는 소셜 계정으로 가입하세요:</p>
        <div class="d-flex justify-content-center">
            <a href="/signUp/google?socialType=google" class="btn btn-danger mr-2" onclick="setSocialType('google')">
                <i class="fab fa-google"></i> Google 회원가입
            </a>
            <a href="/signUp/kakao?socialType=kakao" class="btn btn-warning text-white mr-2" onclick="setSocialType('kakao')">
                <i class="fas fa-comment"></i> Kakao 회원가입
            </a>
            <a href="/signUp/naver?socialType=naver" class="btn btn-success" onclick="setSocialType('naver')">
                <i class="fas fa-user"></i> Naver 회원가입
            </a>
        </div>
    </div>
</div>

<script>
let isEmailValid = false; // 이메일 유효성 확인 변수
let isPhoneNumberVerified = false; // 휴대폰 인증 확인 변수

function setSocialType(type) {
    document.getElementById('socialType').value = type; // 소셜 타입 설정
}

$("#checkDuplicateEmail").on('click', function() {
    const email = document.getElementById('email').value;
    const resultDiv = document.getElementById('emailCheckResult');

    if (!email) {
        resultDiv.innerText = "이메일을 입력해 주세요.";
        resultDiv.style.color = 'red';
        isEmailValid = false;
        return;
    }

    fetch('/user/check-email?email=' + email)
        .then(response => response.json())
        .then(data => {
            resultDiv.innerText = data.message;

            if (data.message === "사용 가능한 이메일입니다.") {
                resultDiv.style.color = 'green';
                isEmailValid = true;
            } else if (data.message === "중복된 이메일은 사용할 수 없습니다.") {
                resultDiv.style.color = 'red';
                isEmailValid = false;
                alert('이메일이 중복되었습니다. 다른 이메일을 사용해 주세요.'); // 알림 창 표시
                location.reload(); // 페이지 리로딩
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultDiv.innerText = "에러가 발생했습니다. 다시 시도해 주세요.";
            resultDiv.style.color = 'red';
            isEmailValid = false;
        });
});

document.getElementById('email').addEventListener('input', function() {
    isEmailValid = false; // 유효성 초기화
    document.getElementById('emailCheckResult').innerText = ""; // 결과 메시지 초기화
});

function pwdCheck() {
    if ($('#password').val() === $('#passwordCheck').val()) {
        $('#pwdConfirm').text('비밀번호 일치').css('color', 'green');
    } else {
        $('#pwdConfirm').text('비밀번호 불일치').css('color', 'red');
    }
}

document.querySelector('#signUpForm').addEventListener('submit', function(event) {
    const passwordMatches = $('#password').val() === $('#passwordCheck').val();
    if (!passwordMatches) {
        event.preventDefault(); // 기본 제출 방지
        alert('비밀번호가 일치하지 않습니다.'); // 경고 메시지
    }
     if (!isPhoneNumberVerified) {
        event.preventDefault(); // 기본 제출 방지
        alert('휴대폰 인증이 완료되지 않았습니다. 인증을 완료해 주세요.'); // 경고 메시지
    }
});

// sms 인증
       $('#sendPhoneNumber').click(function(){
            let phoneNumber = $('#inputPhoneNumber').val();
            Swal.fire('인증번호 발송 완료!')


            $.ajax({
                type: "GET",
                url: "/user/sendSms",
                data: {
                    "phoneNumber" : phoneNumber
                },
                success: function(res){
                    $('#checkBtn').click(function(){
                        if($.trim(res) ==$('#inputCertifiedNumber').val()){
                            Swal.fire(
                                '인증성공!',
                                '휴대폰 인증이 정상적으로 완료되었습니다.',
                                'success'
                            )
                            // 휴대폰 인증 완료 상태 설정
                            isPhoneNumberVerified = true;

                            $.ajax({
                                type: "GET",
                                url: "/update/phone",
                                data: {
                                    "phoneNumber" : $('#inputPhoneNumber').val()
                                }
                            })
                            document.location.href="/home";
                        }else{
                            Swal.fire({
                                icon: 'error',
                                title: '인증오류',
                                text: '인증번호가 올바르지 않습니다!',
                                footer: ''
                            })
                        }
                    })


                }
            })
        });
</script>

{{> layout/footer }}
