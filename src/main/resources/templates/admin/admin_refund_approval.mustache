{{>admin/admin_header}}


<div class="container mt-5">
    <h1>환불</h1>
    <table class="table table-striped">
        <thead>
        <tr>
            <th></th>
            <th>Pay Key</th>
            <th>결제한 유저 ID</th>
            <th>주문번호</th>
            <th>주문내역</th>
            <th>금액</th>
            <th>결제 방법</th>
            <th>요청 시간</th>

        </tr>
        </thead>

        <tbody>
        <!-- 환불하기 버튼-->
        {{#paymentList}}
            <tr>
                <td>{{id}}</td>
                <td>{{paymentKey}}</td>
                <td>{{userId}}</td>
                <td>{{orderId}}</td>
                <td>{{orderName}}</td>
                <td>{{amount}}</td>
                <td>{{method}}</td>
                <td>{{requestedAt}}</td>
                <td><span id="refund--Btn" data-status="{{status}}"><a href="javascript:void(0)"
                                                                       onclick="refund({{id}})" class="btn btn-primary">환불하기</a></span>
                </td>
            </tr>
        {{/paymentList}}
        {{^paymentList}}
            <tr>
                <td colspan="8" class="text-center">결제내역이 없습니다</td>
            </tr>
        {{/paymentList}}
        </tbody>
    </table>

</div>


</body>
</html>

<script>
    window.onload = function() {
        const refundBtns = document.querySelectorAll('#refund--Btn'); // 모든 refund--Btn 요소를 선택

        refundBtns.forEach(refundBtn => {
            const status = refundBtn.getAttribute('data-status');

            // status 값이 1이면 텍스트를 '환불 신청중'으로 변경하고 클릭 비활성화
            if (status === '2') {
                const anchor = refundBtn.querySelector('a');
                anchor.textContent = '처리 완료';
                anchor.style.pointerEvents = 'none'; // 클릭 이벤트 비활성화
                anchor.classList.add('disabled'); // 비활성화 스타일 추가 (선택 사항)
            }
        });
    };
    function refund(id){
        if (confirm("정말 환불처리를 하시겠습니까?")) {
        fetch('http://localhost:8080/toss/refund', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            "id": id,
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('네트워크 오류');
        }
        return response.json();
    })
    .then(data => {
        console.log("응답:", data);
        location.reload();
    })

    .catch(error => {
        console.error("에러 발생:", error);
    });
    }
}
</script>